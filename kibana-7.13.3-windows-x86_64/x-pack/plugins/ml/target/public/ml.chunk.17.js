/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[17],{280:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return processFilters}));var _src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(41);function processFilters(filters,query,controlledBy){const must=["kuery"===query.language?_src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__.esKuery.toElasticsearchQuery(_src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__.esKuery.fromKueryExpression(query.query)):_src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__.esQuery.luceneStringToDsl(query.query)],mustNot=[];for(const filter of filters){if(filter.meta.disabled||void 0!==controlledBy&&filter.meta.controlledBy===controlledBy)continue;const{meta:{negate:negate,type:type,key:fieldName}}=filter;let filterQuery=filter.query;void 0===filterQuery&&"exists"===type&&(filterQuery={exists:{field:fieldName}}),negate?mustNot.push(filterQuery):must.push(filterQuery)}return{bool:{must:must,must_not:mustNot}}}},281:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return getJobsObservable}));var rxjs__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23),rxjs_operators__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(25),lodash__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(7),_common_util_parse_interval__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(26);function getJobsObservable(embeddableInput,anomalyDetectorService,setErrorHandler){return embeddableInput.pipe(Object(rxjs_operators__WEBPACK_IMPORTED_MODULE_1__.pluck)("jobIds"),Object(rxjs_operators__WEBPACK_IMPORTED_MODULE_1__.distinctUntilChanged)(lodash__WEBPACK_IMPORTED_MODULE_2__.isEqual),Object(rxjs_operators__WEBPACK_IMPORTED_MODULE_1__.switchMap)(jobsIds=>anomalyDetectorService.getJobs$(jobsIds)),Object(rxjs_operators__WEBPACK_IMPORTED_MODULE_1__.map)(jobs=>jobs.map(job=>{const bucketSpan=Object(_common_util_parse_interval__WEBPACK_IMPORTED_MODULE_3__.a)(job.analysis_config.bucket_span);return{id:job.job_id,selected:!0,bucketSpanSeconds:bucketSpan.asSeconds()}})),Object(rxjs_operators__WEBPACK_IMPORTED_MODULE_1__.catchError)(e=>{var _e$body;return setErrorHandler(null!==(_e$body=e.body)&&void 0!==_e$body?_e$body:e),Object(rxjs__WEBPACK_IMPORTED_MODULE_0__.of)(void 0)}))}},884:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"EmbeddableAnomalyChartsContainer",(function(){return EmbeddableAnomalyChartsContainer}));var external_kbnSharedDeps_React_=__webpack_require__(14),external_kbnSharedDeps_React_default=__webpack_require__.n(external_kbnSharedDeps_React_),external_kbnSharedDeps_ElasticEui_=__webpack_require__(39),external_kbnSharedDeps_KbnI18nReact_=__webpack_require__(40),external_kbnSharedDeps_Lodash_=__webpack_require__(7),external_kbnSharedDeps_Rxjs_=__webpack_require__(23),external_kbnSharedDeps_RxjsOperators_=__webpack_require__(25),time_buckets=__webpack_require__(90),public_=__webpack_require__(41),explorer_utils=__webpack_require__(99),explorer_constants=__webpack_require__(75),process_filters=__webpack_require__(280),get_jobs_observable=__webpack_require__(281);var external_kbnSharedDeps_KbnI18n_=__webpack_require__(2),explorer_charts_container=__webpack_require__(411),select_severity=__webpack_require__(121);const tooManyBucketsCalloutMsg=external_kbnSharedDeps_KbnI18n_.i18n.translate("xpack.ml.explorer.charts.dashboardTooManyBucketsDescription",{defaultMessage:"This selection contains too many buckets to be displayed. You should shorten the time range of the view."}),ExplorerAnomaliesContainer=({id:id,chartsData:chartsData,showCharts:showCharts,severity:severity,setSeverity:setSeverity,mlUrlGenerator:mlUrlGenerator,timeBuckets:timeBuckets,timefilter:timefilter,onSelectEntity:onSelectEntity,showSelectedInterval:showSelectedInterval})=>external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_default.a.Fragment,null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiFlexGroup,{id:id,direction:"row",gutterSize:"l",responsive:!0,className:"ml-anomalies-controls"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiFlexItem,{grow:!1,style:{width:"170px"}},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiFormRow,{label:external_kbnSharedDeps_KbnI18n_.i18n.translate("xpack.ml.explorer.severityThresholdLabel",{defaultMessage:"Severity threshold"})},external_kbnSharedDeps_React_default.a.createElement(select_severity.c,{severity:severity,onChange:setSeverity})))),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiSpacer,{size:"m"}),Array.isArray(chartsData.seriesToPlot)&&0===chartsData.seriesToPlot.length&&void 0===chartsData.errorMessages&&external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiText,{textAlign:"center","data-test-subj":"mlNoMatchingAnomaliesMessage"},external_kbnSharedDeps_React_default.a.createElement("h4",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_.FormattedMessage,{id:"xpack.ml.explorer.noMatchingAnomaliesFoundTitle",defaultMessage:"No matching anomalies found"}))),external_kbnSharedDeps_React_default.a.createElement("div",{className:"euiText explorer-charts"},showCharts&&external_kbnSharedDeps_React_default.a.createElement(explorer_charts_container.a,{...chartsData,severity:severity.val,mlUrlGenerator:mlUrlGenerator,timeBuckets:timeBuckets,timefilter:timefilter,onSelectEntity:onSelectEntity,tooManyBucketsCalloutMsg:tooManyBucketsCalloutMsg,showSelectedInterval:showSelectedInterval})));var ml_url_generator=__webpack_require__(0),common=__webpack_require__(16),common_=__webpack_require__(28),triggers=__webpack_require__(277);const EmbeddableAnomalyChartsContainer=({id:id,embeddableContext:embeddableContext,embeddableInput:embeddableInput,services:services,refresh:refresh,onInputChange:onInputChange,onOutputChange:onOutputChange})=>{var _embeddableContext$ge;const[chartWidth,setChartWidth]=Object(external_kbnSharedDeps_React_.useState)(0),[severity,setSeverity]=Object(external_kbnSharedDeps_React_.useState)(Object(select_severity.d)(null!==(_embeddableContext$ge=embeddableContext.getInput().severityThreshold)&&void 0!==_embeddableContext$ge?_embeddableContext$ge:common.ANOMALY_THRESHOLD.WARNING)),[selectedEntities,setSelectedEntities]=Object(external_kbnSharedDeps_React_.useState)(),[{uiSettings:uiSettings},{data:dataServices,share:{urlGenerators:{getUrlGenerator:getUrlGenerator}},uiActions:uiActions}]=services,{timefilter:timefilter}=dataServices.query.timefilter,mlUrlGenerator=Object(external_kbnSharedDeps_React_.useMemo)(()=>getUrlGenerator(ml_url_generator.a),[getUrlGenerator]),timeBuckets=Object(external_kbnSharedDeps_React_.useMemo)(()=>new time_buckets.a({"histogram:maxBars":uiSettings.get(common_.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":uiSettings.get(common_.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:uiSettings.get("dateFormat"),"dateFormat:scaled":uiSettings.get("dateFormat:scaled")}),[]);Object(external_kbnSharedDeps_React_.useEffect)(()=>{onInputChange({severityThreshold:severity.val}),onOutputChange({severity:severity.val,entityFields:selectedEntities})},[severity,selectedEntities]);const{chartsData:chartsData,isLoading:isExplorerLoading,error:error}=function(embeddableInput,onInputChange,refresh,services,chartWidth,severity){const[{uiSettings:uiSettings},{data:dataServices},{anomalyDetectorService:anomalyDetectorService,anomalyExplorerService:anomalyExplorerService}]=services,{timefilter:timefilter}=dataServices.query.timefilter,[chartsData,setChartsData]=Object(external_kbnSharedDeps_React_.useState)(),[error,setError]=Object(external_kbnSharedDeps_React_.useState)(),[isLoading,setIsLoading]=Object(external_kbnSharedDeps_React_.useState)(!1),chartWidth$=Object(external_kbnSharedDeps_React_.useMemo)(()=>new external_kbnSharedDeps_Rxjs_.Subject,[]),severity$=Object(external_kbnSharedDeps_React_.useMemo)(()=>new external_kbnSharedDeps_Rxjs_.Subject,[]),timeBuckets=Object(external_kbnSharedDeps_React_.useMemo)(()=>new time_buckets.a({"histogram:maxBars":uiSettings.get(public_.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":uiSettings.get(public_.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:uiSettings.get("dateFormat"),"dateFormat:scaled":uiSettings.get("dateFormat:scaled")}),[]);return Object(external_kbnSharedDeps_React_.useEffect)(()=>{const subscription=Object(external_kbnSharedDeps_Rxjs_.combineLatest)([Object(get_jobs_observable.a)(embeddableInput,anomalyDetectorService,setError),embeddableInput,chartWidth$.pipe(Object(external_kbnSharedDeps_RxjsOperators_.skipWhile)(v=>!v)),severity$,refresh.pipe(Object(external_kbnSharedDeps_RxjsOperators_.startWith)(null))]).pipe(Object(external_kbnSharedDeps_RxjsOperators_.tap)(setIsLoading.bind(null,!0)),Object(external_kbnSharedDeps_RxjsOperators_.debounceTime)(500),Object(external_kbnSharedDeps_RxjsOperators_.switchMap)(([explorerJobs,input,embeddableContainerWidth,severityValue])=>{var _bounds$min,_bounds$max;if(!explorerJobs)return Object(external_kbnSharedDeps_Rxjs_.of)(void 0);const{maxSeriesToPlot:maxSeriesToPlot,timeRange:timeRangeInput,filters:filters,query:query}=input,viewBySwimlaneFieldName=explorer_constants.g;let influencersFilterQuery;anomalyExplorerService.setTimeRange(timeRangeInput);try{influencersFilterQuery=Object(process_filters.a)(filters,query)}catch(e){return setError(e),Object(external_kbnSharedDeps_Rxjs_.of)(void 0)}const bounds=anomalyExplorerService.getTimeBounds(),selections={lanes:[explorer_constants.g],times:[null===(_bounds$min=bounds.min)||void 0===_bounds$min?void 0:_bounds$min.unix(),null===(_bounds$max=bounds.max)||void 0===_bounds$max?void 0:_bounds$max.unix()],type:explorer_constants.h.OVERALL},selectionInfluencers=Object(explorer_utils.i)(selections,viewBySwimlaneFieldName),jobIds=Object(explorer_utils.j)(selections,explorerJobs),bucketInterval=timeBuckets.getInterval(),timeRange=Object(explorer_utils.k)(selections,bucketInterval.asSeconds(),bounds);return Object(external_kbnSharedDeps_Rxjs_.forkJoin)({combinedJobs:anomalyExplorerService.getCombinedJobs(jobIds),anomalyChartRecords:anomalyExplorerService.loadDataForCharts$(jobIds,timeRange.earliestMs,timeRange.latestMs,selectionInfluencers,selections,influencersFilterQuery)}).pipe(Object(external_kbnSharedDeps_RxjsOperators_.switchMap)(({combinedJobs:combinedJobs,anomalyChartRecords:anomalyChartRecords})=>{const combinedJobRecords=combinedJobs.reduce((acc,job)=>({...acc,[job.job_id]:job}),{});return Object(external_kbnSharedDeps_Rxjs_.forkJoin)({chartsData:Object(external_kbnSharedDeps_Rxjs_.from)(anomalyExplorerService.getAnomalyData(void 0,combinedJobRecords,embeddableContainerWidth,anomalyChartRecords,timeRange.earliestMs,timeRange.latestMs,timefilter,severityValue,maxSeriesToPlot))})}))}),Object(external_kbnSharedDeps_RxjsOperators_.catchError)(e=>(setError(e.body),Object(external_kbnSharedDeps_Rxjs_.of)(void 0)))).subscribe(results=>{void 0!==results&&(setError(null),setChartsData(results.chartsData),setIsLoading(!1))});return()=>{subscription.unsubscribe()}},[]),Object(external_kbnSharedDeps_React_.useEffect)(()=>{chartWidth$.next(chartWidth)},[chartWidth]),Object(external_kbnSharedDeps_React_.useEffect)(()=>{severity$.next(severity)},[severity]),{chartsData:chartsData,isLoading:isLoading,error:error}}(embeddableInput,0,refresh,services,chartWidth,severity.val),resizeHandler=Object(external_kbnSharedDeps_React_.useCallback)(Object(external_kbnSharedDeps_Lodash_.throttle)(e=>{setChartWidth(e.width)},500),[]);if(error)return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiCallOut,{title:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_.FormattedMessage,{id:"xpack.ml.anomalyChartsEmbeddable.errorMessage",defaultMessage:"Unable to load the ML anomaly explorer data"}),color:"danger",iconType:"alert",style:{width:"100%"}},external_kbnSharedDeps_React_default.a.createElement("p",null,error.message));const addEntityFieldFilter=(fieldName,fieldValue,operation)=>{const uniqueSelectedEntities=[{fieldName:fieldName,fieldValue:fieldValue,operation:operation}];setSelectedEntities(uniqueSelectedEntities),uiActions.getTrigger(triggers.a).exec({embeddable:embeddableContext,data:uniqueSelectedEntities})};return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiResizeObserver,{onResize:resizeHandler},resizeRef=>external_kbnSharedDeps_React_default.a.createElement("div",{id:"mlAnomalyExplorerEmbeddableWrapper-"+id,style:{width:"100%",overflowY:"auto",overflowX:"hidden",padding:"8px"},"data-test-subj":"mlExplorerEmbeddable_"+embeddableContext.id,ref:resizeRef},isExplorerLoading&&external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiText,{textAlign:"center",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)"}},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_.EuiLoadingChart,{size:"xl",mono:!0,"data-test-subj":"mlAnomalyExplorerEmbeddableLoadingIndicator"})),void 0!==chartsData&&!1===isExplorerLoading&&external_kbnSharedDeps_React_default.a.createElement(ExplorerAnomaliesContainer,{id:id,showCharts:!0,chartsData:chartsData,severity:severity,setSeverity:setSeverity,mlUrlGenerator:mlUrlGenerator,timeBuckets:timeBuckets,timefilter:timefilter,onSelectEntity:addEntityFieldFilter,showSelectedInterval:!1})))};__webpack_exports__.default=EmbeddableAnomalyChartsContainer}}]);