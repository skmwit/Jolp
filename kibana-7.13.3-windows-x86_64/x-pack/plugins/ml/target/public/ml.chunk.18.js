/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[18],{397:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"AnomalyTimelineService",(function(){return AnomalyTimelineService}));var _src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(41),_util_time_buckets__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(90),_explorer_explorer_constants__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(75);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}class AnomalyTimelineService{constructor(timeFilter,uiSettings,mlResultsService){this.timeFilter=timeFilter,this.mlResultsService=mlResultsService,_defineProperty(this,"timeBuckets",void 0),_defineProperty(this,"_customTimeRange",void 0),this.timeBuckets=new _util_time_buckets__WEBPACK_IMPORTED_MODULE_1__.a({"histogram:maxBars":uiSettings.get(_src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":uiSettings.get(_src_plugins_data_public__WEBPACK_IMPORTED_MODULE_0__.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:uiSettings.get("dateFormat"),"dateFormat:scaled":uiSettings.get("dateFormat:scaled")}),this.timeFilter.enableTimeRangeSelector()}setTimeRange(timeRange){this._customTimeRange=timeRange}getSwimlaneBucketInterval(selectedJobs,swimlaneContainerWidth){const bounds=this.getTimeBounds();if(void 0===bounds)throw new Error("timeRangeSelectorEnabled has to be enabled");this.timeBuckets.setInterval("auto"),this.timeBuckets.setBounds(bounds);const intervalSeconds=this.timeBuckets.getInterval().asSeconds(),numBuckets=(bounds.max.valueOf()-bounds.min.valueOf())/1e3/intervalSeconds;Math.floor(swimlaneContainerWidth/numBuckets*100)/100<8&&this.timeBuckets.setInterval(2*intervalSeconds+"s");const maxBucketSpanSeconds=selectedJobs.reduce((memo,job)=>Math.max(memo,job.bucketSpanSeconds),0);return maxBucketSpanSeconds>intervalSeconds&&(this.timeBuckets.setInterval(maxBucketSpanSeconds+"s"),this.timeBuckets.setBounds(bounds)),this.timeBuckets.getInterval()}async loadOverallData(selectedJobs,chartWidth,bucketInterval){const interval=null!=bucketInterval?bucketInterval:this.getSwimlaneBucketInterval(selectedJobs,chartWidth);if(!selectedJobs||!selectedJobs.length)throw new Error("Explorer jobs collection is required");const bounds=this.getTimeBounds(),searchBounds=Object(_util_time_buckets__WEBPACK_IMPORTED_MODULE_1__.b)(bounds,interval,!1),selectedJobIds=selectedJobs.map(d=>d.id),overallBucketsBounds=Object(_util_time_buckets__WEBPACK_IMPORTED_MODULE_1__.b)(bounds,interval,!0),resp=await this.mlResultsService.getOverallBucketScores(selectedJobIds,1,overallBucketsBounds.min.valueOf(),overallBucketsBounds.max.valueOf(),interval.asSeconds()+"s");return this.processOverallResults(resp.results,searchBounds,interval.asSeconds())}async loadViewBySwimlane(fieldValues,bounds,selectedJobs,viewBySwimlaneFieldName,swimlaneLimit,perPage,fromPage,swimlaneContainerWidth,influencersFilterQuery,bucketInterval){const timefilterBounds=this.getTimeBounds();if(void 0===timefilterBounds)throw new Error("timeRangeSelectorEnabled has to be enabled");const swimlaneBucketInterval=null!=bucketInterval?bucketInterval:this.getSwimlaneBucketInterval(selectedJobs,swimlaneContainerWidth),searchBounds=Object(_util_time_buckets__WEBPACK_IMPORTED_MODULE_1__.b)(timefilterBounds,swimlaneBucketInterval,!1),selectedJobIds=selectedJobs.map(d=>d.id),intervalMs=swimlaneBucketInterval.asMilliseconds();let response;if(viewBySwimlaneFieldName===_explorer_explorer_constants__WEBPACK_IMPORTED_MODULE_2__.j){const jobIds=void 0!==fieldValues&&fieldValues.length>0?fieldValues:selectedJobIds;response=await this.mlResultsService.getScoresByBucket(jobIds,searchBounds.min.valueOf(),searchBounds.max.valueOf(),intervalMs,perPage,fromPage)}else response=await this.mlResultsService.getInfluencerValueMaxScoreByTime(selectedJobIds,viewBySwimlaneFieldName,fieldValues,searchBounds.min.valueOf(),searchBounds.max.valueOf(),intervalMs,swimlaneLimit,perPage,fromPage,influencersFilterQuery);if(void 0===response)return;return this.processViewByResults(response.results,response.cardinality,fieldValues,bounds,viewBySwimlaneFieldName,swimlaneBucketInterval.asSeconds())}async loadViewByTopFieldValuesForSelectedTime(earliestMs,latestMs,selectedJobs,viewBySwimlaneFieldName,swimlaneLimit,perPage,fromPage,swimlaneContainerWidth){const selectedJobIds=selectedJobs.map(d=>d.id);if(viewBySwimlaneFieldName!==_explorer_explorer_constants__WEBPACK_IMPORTED_MODULE_2__.j){const resp=await this.mlResultsService.getTopInfluencers(selectedJobIds,earliestMs,latestMs,swimlaneLimit,perPage,fromPage);if(void 0===resp.influencers[viewBySwimlaneFieldName])return[];const topFieldValues=[],topInfluencers=resp.influencers[viewBySwimlaneFieldName];return Array.isArray(topInfluencers)&&topInfluencers.forEach(influencerData=>{influencerData.maxAnomalyScore>0&&topFieldValues.push(influencerData.influencerFieldValue)}),topFieldValues}{const resp=await this.mlResultsService.getScoresByBucket(selectedJobIds,earliestMs,latestMs,this.getSwimlaneBucketInterval(selectedJobs,swimlaneContainerWidth).asMilliseconds(),swimlaneLimit);return Object.keys(resp.results)}}getTimeBounds(){return void 0!==this._customTimeRange?this.timeFilter.calculateBounds(this._customTimeRange):this.timeFilter.getBounds()}processOverallResults(scoresByTime,searchBounds,interval){const overallLabel=_explorer_explorer_constants__WEBPACK_IMPORTED_MODULE_2__.g,dataset={laneLabels:[overallLabel],points:[],interval:interval,earliest:searchBounds.min.valueOf()/1e3,latest:searchBounds.max.valueOf()/1e3};return Object.entries(scoresByTime).forEach(([timeMs,score])=>{const time=+timeMs/1e3;dataset.points.push({laneLabel:overallLabel,time:time,value:score}),dataset.earliest=Math.min(time,dataset.earliest),dataset.latest=Math.max(time+dataset.interval,dataset.latest)}),dataset}processViewByResults(scoresByInfluencerAndTime,cardinality,sortedLaneValues,bounds,viewBySwimlaneFieldName,interval){const dataset={fieldName:viewBySwimlaneFieldName,points:[],laneLabels:[],interval:interval,earliest:bounds.earliest,latest:bounds.latest,cardinality:cardinality},maxScoreByLaneLabel={};Object.entries(scoresByInfluencerAndTime).forEach(([influencerFieldValue,influencerData])=>{dataset.laneLabels.push(influencerFieldValue),maxScoreByLaneLabel[influencerFieldValue]=0,Object.entries(influencerData).forEach(([timeMs,anomalyScore])=>{const time=+timeMs/1e3;dataset.points.push({laneLabel:influencerFieldValue,time:time,value:anomalyScore}),maxScoreByLaneLabel[influencerFieldValue]=Math.max(maxScoreByLaneLabel[influencerFieldValue],anomalyScore)})});const sortValuesLength=sortedLaneValues.length;return dataset.laneLabels=0===sortValuesLength?dataset.laneLabels.sort((a,b)=>maxScoreByLaneLabel[b]-maxScoreByLaneLabel[a]):dataset.laneLabels.sort((a,b)=>{let aIndex=sortedLaneValues.indexOf(a),bIndex=sortedLaneValues.indexOf(b);return aIndex=aIndex>-1?aIndex:sortValuesLength,bIndex=bIndex>-1?bIndex:sortValuesLength,aIndex-bIndex}),dataset}}},90:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"c",(function(){return getTimeBucketsFromCache})),__webpack_require__.d(__webpack_exports__,"a",(function(){return TimeBuckets})),__webpack_require__.d(__webpack_exports__,"b",(function(){return getBoundsRoundedToInterval}));var external_kbnSharedDeps_Lodash_=__webpack_require__(7),external_kbnSharedDeps_Moment_=__webpack_require__(15),external_kbnSharedDeps_Moment_default=__webpack_require__.n(external_kbnSharedDeps_Moment_),datemath_target=__webpack_require__(30),target_default=__webpack_require__.n(datemath_target);const{duration:d}=external_kbnSharedDeps_Moment_default.a;var parse_interval=__webpack_require__(26),dependency_cache=__webpack_require__(22),public_=__webpack_require__(41);const unitsDesc=target_default.a.unitsDesc,timeUnitsMaxSupportedIndex=unitsDesc.indexOf("w"),calcAuto=function(){const revRoundingRules=[[d(500,"ms"),d(100,"ms")],[d(5,"second"),d(1,"second")],[d(10,"second"),d(5,"second")],[d(15,"second"),d(10,"second")],[d(30,"second"),d(15,"second")],[d(1,"minute"),d(30,"second")],[d(5,"minute"),d(1,"minute")],[d(10,"minute"),d(5,"minute")],[d(15,"minute"),d(10,"minute")],[d(30,"minute"),d(10,"minute")],[d(1,"hour"),d(30,"minute")],[d(2,"hour"),d(1,"hour")],[d(4,"hour"),d(2,"hour")],[d(6,"hour"),d(4,"hour")],[d(8,"hour"),d(6,"hour")],[d(12,"hour"),d(8,"hour")],[d(24,"hour"),d(12,"hour")],[d(2,"d"),d(1,"d")],[d(4,"d"),d(2,"d")],[d(1,"week"),d(4,"d")],[d(1,"month"),d(1,"week")],[d(1,"year"),d(1,"month")],[1/0,d(1,"year")]].slice(0).reverse();function find(rules,check,last){return function(buckets,duration){const interval=function(buckets,duration){const target=duration/buckets;let lastResp;for(let i=0;i<rules.length;i++){const rule=rules[i],resp=check(rule[0],rule[1],target);if(null==resp){if(!last)continue;if(lastResp)return lastResp;break}if(!last)return resp;lastResp=resp}const ms=Math.max(Math.floor(target),1);return external_kbnSharedDeps_Moment_default.a.duration(ms,"ms")}(buckets,duration);if(interval)return external_kbnSharedDeps_Moment_default.a.duration(interval._data)}}return{near:find(revRoundingRules,(function(upperBound,lowerBound,target){if(upperBound>target){if(upperBound===1/0)return lowerBound;const boundMs=upperBound.asMilliseconds(),intervalMs=lowerBound.asMilliseconds();return Math.abs(boundMs-target)<=Math.abs(intervalMs)?upperBound:lowerBound}}),!0),lessThan:find(revRoundingRules,(function(upperBound,lowerBound,target){if(lowerBound<target)return upperBound!==1/0?upperBound:lowerBound})),atLeast:find(revRoundingRules,(function(upperBound,lowerBound,target){if(lowerBound<=target)return lowerBound}))}}();function getTimeBucketsFromCache(){const uiSettings=Object(dependency_cache.k)();return new TimeBuckets({[public_.UI_SETTINGS.HISTOGRAM_MAX_BARS]:uiSettings.get(public_.UI_SETTINGS.HISTOGRAM_MAX_BARS),[public_.UI_SETTINGS.HISTOGRAM_BAR_TARGET]:uiSettings.get(public_.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:uiSettings.get("dateFormat"),"dateFormat:scaled":uiSettings.get("dateFormat:scaled")})}function TimeBuckets(timeBucketsConfig){this._timeBucketsConfig=timeBucketsConfig,this.barTarget=this._timeBucketsConfig[public_.UI_SETTINGS.HISTOGRAM_BAR_TARGET],this.maxBars=this._timeBucketsConfig[public_.UI_SETTINGS.HISTOGRAM_MAX_BARS]}function decorateInterval(interval,originalDuration){const esInterval=function(duration){for(let i=0;i<unitsDesc.length;i++){const unit=unitsDesc[i],val=duration.as(unit);if(val>=1&&Math.floor(val)===val){if(i<=timeUnitsMaxSupportedIndex)continue;return{value:val,unit:unit,expression:val+unit}}}const ms=duration.as("ms");return{value:ms,unit:"ms",expression:ms+"ms"}}(interval);interval.esValue=esInterval.value,interval.esUnit=esInterval.unit,interval.expression=esInterval.expression,interval.overflow=originalDuration>interval&&external_kbnSharedDeps_Moment_default.a.duration(interval-originalDuration);const prettyUnits=external_kbnSharedDeps_Moment_default.a.normalizeUnits(esInterval.unit);return 1===esInterval.value?interval.description=prettyUnits:interval.description=`${esInterval.value} ${prettyUnits}s`,interval}function isValidMoment(m){return m&&"isValid"in m&&m.isValid()}function getBoundsRoundedToInterval(bounds,interval,inclusiveEnd=!1){const intervalMs=interval.asMilliseconds(),adjustedMinMs=Math.floor(bounds.min.valueOf()/intervalMs)*intervalMs;let adjustedMaxMs=Math.ceil(bounds.max.valueOf()/intervalMs)*intervalMs;return!1===inclusiveEnd&&(adjustedMaxMs-=1),{min:external_kbnSharedDeps_Moment_default()(adjustedMinMs),max:external_kbnSharedDeps_Moment_default()(adjustedMaxMs)}}TimeBuckets.prototype.setBarTarget=function(bt){this.barTarget=bt},TimeBuckets.prototype.setMaxBars=function(mb){this.maxBars=mb},TimeBuckets.prototype.setBounds=function(input){if(!input)return this.clearBounds();let bounds;bounds=Object(external_kbnSharedDeps_Lodash_.isPlainObject)(input)?[input.min,input.max]:Array.isArray(input)?input:[];const moments=Object(external_kbnSharedDeps_Lodash_.sortBy)(bounds.map(Object(external_kbnSharedDeps_Lodash_.ary)(external_kbnSharedDeps_Moment_default.a,1)),Number);if(!(2===moments.length&&moments.every(isValidMoment)))throw this.clearBounds(),new Error("invalid bounds set: "+input);if(this._lb=moments.shift(),this._ub=moments.pop(),this.getDuration().asSeconds()<0)throw new TypeError("Intervals must be positive")},TimeBuckets.prototype.clearBounds=function(){this._lb=this._ub=null},TimeBuckets.prototype.hasBounds=function(){return isValidMoment(this._ub)&&isValidMoment(this._lb)},TimeBuckets.prototype.getBounds=function(){if(this.hasBounds())return{min:this._lb,max:this._ub}},TimeBuckets.prototype.getDuration=function(){if(this.hasBounds())return external_kbnSharedDeps_Moment_default.a.duration(this._ub-this._lb,"ms")},TimeBuckets.prototype.setInterval=function(input){this.originalInterval=input;let interval=input;if(interval&&"auto"!==interval){if(Object(external_kbnSharedDeps_Lodash_.isString)(interval)&&(input=interval,interval=Object(parse_interval.a)(interval),0==+interval&&(interval=null)),!external_kbnSharedDeps_Moment_default.a.isDuration(interval))throw new TypeError('"'+input+'" is not a valid interval.');this._i=interval}else this._i="auto"},TimeBuckets.prototype.getInterval=function(){const self=this,duration=self.getDuration();return decorateInterval(function(interval){if(!self.hasBounds())return interval;const maxLength=self.maxBars;let scaled;if(!(duration/interval>maxLength))return interval;scaled=calcAuto.lessThan(maxLength,duration);return+scaled==+interval?interval:(decorateInterval(interval,duration),Object(external_kbnSharedDeps_Lodash_.assign)(scaled,{preScaled:interval,scale:interval/scaled,scaled:!0}))}(function(){const interval=self._i;return external_kbnSharedDeps_Moment_default.a.isDuration(interval)?interval:calcAuto.near(self.barTarget,duration)}()),duration)},TimeBuckets.prototype.getIntervalToNearestMultiple=function(divisorSecs){const interval=this.getInterval(),intervalSecs=interval.asSeconds(),remainder=intervalSecs%divisorSecs;if(0===remainder)return interval;let nearestMultiple=remainder>divisorSecs/2?intervalSecs+divisorSecs-remainder:intervalSecs-remainder;nearestMultiple=0===nearestMultiple?divisorSecs:nearestMultiple;const nearestMultipleInt=external_kbnSharedDeps_Moment_default.a.duration(nearestMultiple,"seconds");decorateInterval(nearestMultipleInt,this.getDuration());const preScaled=interval.preScaled;return void 0!==preScaled&&preScaled<nearestMultipleInt&&(nearestMultipleInt.preScaled=preScaled,nearestMultipleInt.scale=preScaled/nearestMultipleInt,nearestMultipleInt.scaled=!0),nearestMultipleInt},TimeBuckets.prototype.getScaledDateFormat=function(){const interval=this.getInterval(),rules=this._timeBucketsConfig["dateFormat:scaled"];for(let i=rules.length-1;i>=0;i--){const rule=rules[i];if(!rule[0]||interval>=external_kbnSharedDeps_Moment_default.a.duration(rule[0]))return rule[1]}return this._timeBucketsConfig.dateFormat},TimeBuckets.prototype.getScaledDateFormatter=function(){return new(Object(dependency_cache.c)().getType(public_.FIELD_FORMAT_IDS.DATE))({pattern:this.getScaledDateFormat()},this._timeBucketsConfig)}}}]);